name: "Regression Check"

on:
  workflow_dispatch:
    inputs:
      baseline-sha:
        description: "The SHA to use as the baseline (optional)"
        required: false
      comparison-sha:
        description: "The SHA to use for comparison (optional)"
        required: false

jobs:
  resolve-shas:
    runs-on: ubuntu-latest
    outputs:
      baseline-valid: ${{ steps.validate_baseline_sha.outputs.valid }}
      comparison-valid: ${{ steps.validate_comparison_sha.outputs.valid }}
      baseline-sha: ${{ steps.set_shas.outputs.baseline_sha }}
      comparison-sha: ${{ steps.set_shas.outputs.comparison_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set SHAs
        id: set_shas
        run: |
          if [ -z "${{ github.event.inputs.baseline-sha }}" ]; then
            BASELINE_SHA=$(git rev-list -n 1 --before="24 hours ago" origin/master)
            echo "Using baseline SHA from 24 hours ago: $BASELINE_SHA"
          else
            BASELINE_SHA="${{ github.event.inputs.baseline-sha }}"
            echo "Using provided baseline SHA: $BASELINE_SHA"
          fi
          
          if [ -z "${{ github.event.inputs.comparison-sha }}" ]; then
            COMPARISON_SHA=$(git rev-parse origin/master)
            echo "Using current HEAD for comparison SHA: $COMPARISON_SHA"
          else
            COMPARISON_SHA="${{ github.event.inputs.comparison-sha }}"
            echo "Using provided comparison SHA: $COMPARISON_SHA"
          fi
          
          echo "baseline_sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
          echo "comparison_sha=$COMPARISON_SHA" >> $GITHUB_OUTPUT

      - name: Validate baseline-sha
        id: validate_baseline_sha
        run: |
          if git cat-file -e "${{ steps.set_shas.outputs.baseline_sha }}^{commit}"; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "Baseline SHA is valid."
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "Invalid baseline SHA: ${{ steps.set_shas.outputs.baseline_sha }}."
            exit 1
          fi
        outputs:
          valid: ${{ steps.validate_baseline_sha.outputs.valid }}

      - name: Validate comparison-sha
        id: validate_comparison_sha
        run: |
          if git cat-file -e "${{ steps.set_shas.outputs.comparison_sha }}^{commit}"; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "Comparison SHA is valid."
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "Invalid comparison SHA: ${{ steps.set_shas.outputs.comparison_sha }}."
            exit 1
          fi
        outputs:
          valid: ${{ steps.validate_comparison_sha.outputs.valid }}

      - name: Stop workflow if any SHA is invalid
        run: |
          if [ "${{ steps.validate_baseline_sha.outputs.valid }}" != "true" ] || [ "${{ steps.validate_comparison_sha.outputs.valid }}" != "true" ]; then
            echo "One or more SHAs are invalid. Stopping the workflow."
            exit 1
          fi

      - name: Output valid SHAs
        if: success()
        run: |
          echo "Both baseline-sha and comparison-sha are valid."

  display-results:
    runs-on: ubuntu-latest
    needs: resolve-shas
    steps:
      - name: Display Results
        run: |
          echo "Baseline SHA: ${{ needs.resolve-shas.outputs.baseline-sha }}"
          echo "Comparison SHA: ${{ needs.resolve-shas.outputs.comparison-sha }}"
          echo "Baseline SHA valid: ${{ needs.resolve-shas.outputs.baseline-valid }}"
          echo "Comparison SHA valid: ${{ needs.resolve-shas.outputs.comparison-valid }}"
